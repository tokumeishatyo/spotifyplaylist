## Spotifyプレイリスト管理アプリケーション 要件定義書【最終版 v2】

### 1. 概要

#### 1.1. アプリケーションの目的
本アプリケーションは、ユーザーが自身のSpotifyアカウントに連携し、Webブラウザ上で直感的にプレイリストおよびプレイリスト内の楽曲を管理・整理することを目的とする。特に、不要になったプレイリストや楽曲を簡単に選択し、一括で削除する機能を提供することで、ユーザーの音楽ライブラリのメンテナンスを効率化する。

#### 1.2. アプリケーションの概要
Spotifyアカウントでログインすることで、ユーザーが所有またはフォローしているプレイリストの一覧を表示するWebアプリケーション。ユーザーは各プレイリストを展開して楽曲を確認し、不要なアイテム（プレイリスト/楽曲）をチェックボックスで選択後、一括で削除することができる。

#### 1.3. ターゲットユーザー
日常的にSpotifyを利用し、多数のプレイリストや楽曲を管理しているユーザー。

#### 1.4. 前提条件
本アプリケーションは、**個人のローカルマシン環境でのみ使用**することを前提とする。インターネット上へのデプロイ（公開）は想定しない。

### 2. システム要件

#### 2.1. システム構成
- **種別:** Webアプリケーション
- **フロントエンド:** HTML, CSS, JavaScript
- **バックエンド:** **Node.js (Express等) を必須とする。**
    - **役割:**
        1.  ローカルWebサーバーの起動
        2.  Spotify APIとの認証処理
        3.  アクセストークンのセッション管理
- **実行環境:** ローカルマシン
- **アクセスURL:** ~~**`https://localhost:8089`**~~
  **`http://localhost:5173`**
- **通信プロトコル:** ~~**HTTPS**~~
  **HTTP**
    - ~~ローカル環境でHTTPSを実現するため、**自己署名証明書**を作成し、バックエンドサーバーに設定する。~~
    - ローカル環境のため、HTTPを使用する。

#### 2.2. 動作環境
- **対応ブラウザ:** Google Chrome, Mozilla Firefox, Apple Safari, Microsoft Edge の最新バージョン

### 3. 機能要件

#### 3.1. 機能一覧
| 機能ID | 機能名 | 概要 |
| :--- | :--- | :--- |
| F-01 | Spotify認証機能 | Spotifyアカウントを利用してアプリケーションにログイン・ログアウトする。 |
| F-02 | プレイリスト一覧表示機能 | ログインユーザーのプレイリストを一覧で表示する。 |
| F-03 | 楽曲一覧表示機能 | プレイリスト内の楽曲を一覧で表示する。 |
| F-04 | アイテム選択機能 | 削除対象のプレイリストや楽曲をチェックボックスで選択する。 |
| F-05 | アイテム削除機能 | 選択したアイテムをSpotifyアカウントから削除する。 |

#### 3.2. 画面構成
| 画面ID | 画面名 | 概要 |
| :--- | :--- | :--- |
| S-01 | （ログインリダイレクト） | アプリケーションへの初期アクセス時にSpotify認証へ遷移させる。 |
| S-02 | プレイリスト管理画面 | ログイン後に表示されるメイン画面。プレイリストと楽曲の表示、選択、削除を行う。 |

#### 3.3. 機能詳細

##### 3.3.1. F-01: Spotify認証機能
1.  **ログインフロー:**
    -   ユーザーがブラウザで ~~`https://localhost:8089`~~ `http://localhost:5173` にアクセスする。
    -   バックエンドサーバーは、ユーザーのセッション情報（ログイン状態）を確認し、存在しない場合は**自動的にSpotifyの認証ページへリダイレクトさせる。**
    -   ユーザーがSpotify上で認証とアクセス許可を行うと、Spotifyは設定されたリダイレクトURI（~~`https://localhost:8089/callback`~~ `http://localhost:5173/callback`）に認証コードを付与してコールバックする。
    -   バックエンドサーバーが認証コードを受け取り、アクセストークンを取得後、ユーザーをS-02 プレイリスト管理画面へリダイレクトする。
2.  **ログアウト処理:**
    -   アクセストークンは、**ブラウザを閉じると自動的に破棄されるサーバーサイドのセッション**に保存する。
    -   これにより、ユーザーがブラウザを閉じるとセッションが切れ、事実上のログアウト状態となる。再度 ~~`https://localhost:8089`~~ `http://localhost:5173` にアクセスした際には、改めてログインフローが開始される。
3.  **必要なAPIスコープ:**
    -   `playlist-read-private`
    -   `playlist-read-collaborative`
    -   `playlist-modify-public`
    -   `playlist-modify-private`
4.  **補足:**
    -   認証フローの実装にあたっては、Authorization Code Flowの詳細を確認すること。必要に応じて https://developer.spotify.com/documentation/web-api を参照のこと。

##### 3.3.2. F-02: プレイリスト一覧表示機能
1.  **表示タイミング:** ログイン成功後、S-02 プレイリスト管理画面に自動で表示される。
2.  **表示形式:**
    -   各プレイリストは「**プレイリストのカバー画像 - プレイリストのタイトル**」の形式で表示する。
    -   各プレイリスト項目の先頭に、アイテム選択用のチェックボックスを配置する。
3.  **利用API:** `GET /v1/me/playlists`
4.  **補足:**
    -   APIエンドポイントのパラメータやレスポンス形式の詳細は、公式ドキュメントで確認すること。必要に応じて https://developer.spotify.com/documentation/web-api を参照のこと。

##### 3.3.3. F-03: 楽曲一覧表示機能
1.  **実装方法:**
    -   プレイリスト一覧はHTMLの`<details>`タグを用いて実装する。`<summary>`部分にプレイリスト情報を表示する。
2.  **展開・表示:**
    -   ユーザーがプレイリスト項目をクリックすると、`<details>`が展開され、内部にそのプレイリストに含まれる楽曲一覧が表示される。
3.  **表示形式:**
    -   各楽曲は「**楽曲のアルバムカバー画像 - 曲のタイトル - アーティスト名**」の形式で表示する。
    -   各楽曲項目の先頭に、アイテム選択用のチェックボックスを配置する。
4.  **利用API:** `GET /v1/playlists/{playlist_id}/tracks`
5.  **補足:**
    -   APIエンドポイントのパラメータやレスポンス形式の詳細は、公式ドキュメントで確認すること。必要に応じて https://developer.spotify.com/documentation/web-api を参照のこと。

##### 3.3.4. F-04: アイテム選択機能
1.  **選択操作:** ユーザーはプレイリストまたは楽曲の横にあるチェックボックスをクリックし、ON/OFFを切り替える。
2.  **ボタン制御:**
    -   チェックボックスが1つでもONの状態になると、画面下部の「Delete」ボタンが活性化（クリック可能）する。
    -   全てのチェックボックスがOFFの場合、「Delete」ボタンは非活性（クリック不可）とする。

##### 3.3.5. F-05: アイテム削除機能
1.  **実行トリガー:** ユーザーが活性化された「Delete」ボタンをクリックする。
2.  **確認処理:**
    -   ボタンクリック後、「選択したアイテムを削除します。この操作は元に戻せません。よろしいですか？」といった確認ダイアログ（メッセージボックス）を表示する。
    -   ユーザーが「OK」をクリックした場合のみ、削除処理を続行する。
3.  **削除処理:**
    -   **プレイリストが選択されている場合:** 選択されたプレイリストのフォローを解除する。（利用API: `DELETE /v1/playlists/{playlist_id}/followers`）
    -   **楽曲が選択されている場合:** 選択された楽曲を、それが属するプレイリストから削除する。（利用API: `DELETE /v1/playlists/{playlist_id}/tracks`）
    -   一度に101件以上の楽曲を削除する場合は、APIの仕様（上限100件）に従い、リクエストを分割して実行する。
4.  **完了後処理:**
    -   削除処理が完了したら、成功した旨をユーザーに通知し、プレイリスト一覧をリフレッシュして最新の状態を表示する。
5.  **補足:**
    -   削除APIのリクエストボディの形式や仕様の詳細は、公式ドキュメントで確認すること。必要に応じて https://developer.spotify.com/documentation/web-api を参照のこと。

### 4. 非機能要件

#### 4.1. ユーザビリティ・UI/UX
-   **レスポンシブデザイン:** PCの画面サイズで最適に表示・操作できること。
-   **フィードバック:** API通信中や削除処理中など、時間がかかる処理ではローディングインジケーターを表示し、ユーザーに処理中であることが分かるようにする。
-   **エラーハンドリング:** APIエラーや通信失敗が発生した場合は、ユーザーに分かりやすいエラーメッセージを表示する。

#### 4.2. パフォーマンス
-   **API効率:** 不要なAPIリクエストを削減するため、一度取得したプレイリスト内の楽曲データは、ページをリロードするまでキャッシュすることが望ましい。

#### 4.3. セキュリティ
-   **認証情報の管理:**
    -   Spotify APIの `Client ID` および `Client Secret` は、プロジェクトのルートディレクトリに配置した **`.env` ファイル**に記述して管理する。
    -   これらの値は、バックエンドサーバーの起動時に環境変数として読み込む。
    -   `.env` ファイルは、Gitなどのバージョン管理システムの追跡対象から除外するため、必ず `.gitignore` ファイルに記述すること。
-   **Client Secretの秘匿:**
    -   `Client Secret` は、アクセストークン取得のために**バックエンドサーバーでのみ使用**し、HTMLやクライアントサイドJavaScriptなどのフロントエンドコードには一切含めない。
-   **通信:**
    -   ~~バックエンドサーバーとクライアント（ブラウザ）間の全ての通信は、**自己署名証明書を用いたHTTPS**で暗号化する。~~
    -   ローカル環境のため、HTTPで通信する。

### 5. 外部インターフェース

#### 5.1. Spotify Web API
-   **API規約:** Spotify Web APIの利用規約およびデザインガイドラインを遵守する。
-   **レートリミット:** APIのリクエスト数制限（レートリミット）を考慮し、万が一制限に達した場合は、エラーメッセージを表示する等の適切な処理を行う。

### 6. その他

#### 6.1. 留意事項
-   ユーザーがフォローしているだけで編集権限のないプレイリスト（例: Spotify公式プレイリスト）内の楽曲は削除できない。このようなプレイリストについては、楽曲のチェックボックスを非表示または非活性にするなどのUI上の工夫が必要となる。